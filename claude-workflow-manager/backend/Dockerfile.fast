# Fast Backend Dockerfile - Uses pre-built base image
ARG BASE_IMAGE=ghcr.io/your-org/claude-workflow-backend-base:latest
FROM ${BASE_IMAGE}

# Switch to root to copy files
USER root

# Copy source code (NEVER cached - always fresh)
COPY . .

# Ensure proper ownership
RUN chown -R claude:claude /app

# Note: We DON'T switch back to USER claude here because the entrypoint script
# needs to run as root to start dockerd, then it switches to claude user

# The base image ENTRYPOINT will handle dockerd startup and user switching
# Override CMD to use the appropriate main.py location
CMD ["/opt/venv/bin/uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]