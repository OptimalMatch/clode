# Terminal Base Image - Contains all OS packages and dependencies for Claude Terminal
# This image is built separately and cached for fast deployments
FROM ubuntu:22.04

# Set non-interactive mode to avoid prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install all required packages in one optimized layer
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Core system
    ca-certificates \
    curl \
    wget \
    unzip \
    zip \
    gnupg \
    lsb-release \
    # Python stack
    python3 \
    python3-pip \
    python3-venv \
    # Development tools
    git \
    build-essential \
    # Terminal essentials (REQUIRED for Claude Code)
    sudo \
    locales \
    tmux \
    screen \
    procps \
    # Additional dependencies for Claude CLI
    xvfb \
    libnss3 \
    libatk-bridge2.0-0 \
    libdrm2 \
    libxcomposite1 \
    libxdamage1 \
    libxrandr2 \
    libgbm1 \
    libxss1 \
    libasound2 \
    # Docker dependencies
    apt-transport-https \
    software-properties-common \
    iptables \
    supervisor \
    fuse-overlayfs \
    # Common development tools often needed by projects
    # Install multiple Java versions for compatibility
    openjdk-8-jdk \
    openjdk-11-jdk \
    openjdk-17-jdk \
    openjdk-21-jdk \
    maven \
    make \
    cmake \
    vim \
    nano \
    && curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* \
    && ln -s /usr/bin/python3 /usr/bin/python

# Install Docker CE
RUN curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && apt-get update \
    && apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Docker Compose standalone
RUN curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose \
    && chmod +x /usr/local/bin/docker-compose

# Set Java 17 as default (most compatible with modern Spring Boot)
RUN update-alternatives --set java /usr/lib/jvm/java-17-openjdk-amd64/bin/java && \
    update-alternatives --set javac /usr/lib/jvm/java-17-openjdk-amd64/bin/javac
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64

# Install Gradle 8.5
RUN curl -L https://services.gradle.org/distributions/gradle-8.5-bin.zip -o /tmp/gradle.zip && \
    unzip -q /tmp/gradle.zip -d /opt && \
    rm /tmp/gradle.zip && \
    ln -s /opt/gradle-8.5/bin/gradle /usr/local/bin/gradle

# Set environment variables
ENV GRADLE_HOME=/opt/gradle-8.5
ENV PATH="${GRADLE_HOME}/bin:${PATH}"

# Set up locale properly (REQUIRED for Claude Code text handling)
RUN echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && \
    locale-gen && \
    update-locale LANG=en_US.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US:en
ENV LC_ALL en_US.UTF-8

# Install Claude CLI (use the version compatible with Node.js 18)
RUN echo "Installing Claude CLI..." && \
    npm install -g @anthropic-ai/claude-code || \
    (echo "NPM install failed, trying curl method..." && \
     curl -fsSL https://claude.ai/cli/install.sh | bash 2>/dev/null || \
     echo "⚠️ Claude CLI installation failed, will install at runtime")

# Verify Claude CLI installation
RUN which claude || echo "Claude CLI not found in PATH"
RUN claude --version || echo "Claude CLI version check failed"

ENV PATH="/home/claude/.npm-global/bin:/home/claude/.local/bin:/usr/local/bin:$PATH"

# Create app directory
WORKDIR /app

# Create directories for profiles, sessions, and project
RUN mkdir -p /app/claude_profiles /app/terminal_sessions /app/project

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional dependencies for terminal server
RUN pip install --no-cache-dir \
    pexpect \
    ptyprocess \
    asyncio-mqtt \
    python-multipart

# Configure Docker daemon for DinD
RUN mkdir -p /etc/docker && \
    echo '{\n  "storage-driver": "overlay2",\n  "storage-opts": ["overlay2.override_kernel_check=true"],\n  "hosts": ["unix:///var/run/docker.sock"],\n  "log-driver": "json-file",\n  "log-opts": {\n    "max-size": "10m",\n    "max-file": "3"\n  }\n}' > /etc/docker/daemon.json

# Create Docker startup script
RUN echo '#!/bin/bash\n\
# Start Docker daemon in background\n\
dockerd --host=unix:///var/run/docker.sock --storage-driver=overlay2 &\n\
DOCKER_PID=$!\n\
\n\
# Wait for Docker to be ready\n\
timeout=30\n\
while [ $timeout -gt 0 ]; do\n\
    if docker version >/dev/null 2>&1; then\n\
        echo "Docker daemon is ready"\n\
        break\n\
    fi\n\
    timeout=$((timeout - 1))\n\
    sleep 1\n\
done\n\
\n\
if [ $timeout -eq 0 ]; then\n\
    echo "Docker daemon failed to start"\n\
    exit 1\n\
fi\n\
\n\
# Execute the main command\n\
exec "$@"' > /usr/local/bin/docker-entrypoint.sh && \
    chmod +x /usr/local/bin/docker-entrypoint.sh

# Create non-root user for better security
RUN useradd -m -s /bin/bash claude && \
    # Add passwordless sudo ONLY for package managers (doesn't interfere with Claude autonomous mode)
    echo "claude ALL=(ALL) NOPASSWD: /usr/bin/apt-get, /usr/bin/apt, /usr/bin/dpkg, /usr/bin/npm, /usr/bin/pip, /usr/bin/pip3" > /etc/sudoers.d/claude && \
    chmod 0440 /etc/sudoers.d/claude && \
    # Add claude user to docker group for Docker-in-Docker
    usermod -aG docker claude

# Set up npm global directory for claude user
USER claude
WORKDIR /home/claude
RUN mkdir -p /home/claude/.npm-global && \
    mkdir -p /home/claude/.claude && \
    npm config set prefix '/home/claude/.npm-global' && \
    echo 'export PATH=/home/claude/.npm-global/bin:$PATH' >> /home/claude/.bashrc

# Switch back to root for final setup
USER root
WORKDIR /app

# Change ownership of directories
RUN chown -R claude:claude /app /home/claude && \
    mkdir -p /app/claude_profiles /app/terminal_sessions /app/project && \
    chown -R claude:claude /app/claude_profiles /app/terminal_sessions /app/project && \
    chmod 777 /app/project

# Environment variables
ENV PYTHONPATH=/app
ENV CLAUDE_HOME=/home/claude/.claude
ENV TERMINAL_SERVER_PORT=8006
ENV WEBSOCKET_HOST=0.0.0.0

# Expose the terminal server port and health port
EXPOSE 8006
EXPOSE 8007

# Health check for terminal server using dedicated health port
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8007/health || exit 1

# Switch to claude user for runtime
USER claude

# Default command (will be overridden by deployment Dockerfile)
ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
CMD ["python", "terminal_server.py"]
