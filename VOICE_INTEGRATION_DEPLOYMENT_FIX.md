# Voice Integration Deployment Fix

## Issues Fixed

### 1. Voice Services Not Found During Deployment
**Error:** `unable to prepare context: path "/home/github-runner/claude-workflow-manager-deploy/voice-backend" not found`

**Root Cause:** The deployment workflow only copied the `claude-workflow-manager` directory, but `voice-backend` and `voice-mcp-server` are at the repository root level.

**Fix:** Updated `.github/workflows/deploy-self-hosted.yml` to copy voice service directories when Picovoice key is available:
```bash
if [ -n "${{ secrets.PICOVOICE_ACCESS_KEY }}" ]; then
  echo "ðŸŽ¤ Copying voice services..."
  cp -r $GITHUB_WORKSPACE/voice-backend .
  cp -r $GITHUB_WORKSPACE/voice-mcp-server .
fi
```

### 2. Docker Network Not Found
**Error:** `network claude-network declared as external, but could not be found`

**Root Cause:** `docker-compose.voice.yml` declared the network as `external: true`, which overrides the base `docker-compose.yml` network definition.

**Fix:** Removed the network declaration from `docker-compose.voice.yml` since it's already defined in the base compose file.

### 3. Frontend Unable to Connect to Voice API
**Error:** `POST http://localhost:14300/api/tts/stream net::ERR_CONNECTION_REFUSED`

**Root Cause:** The frontend was hardcoded to use `localhost:14300`, but the voice backend runs on the self-hosted server. React environment variables need to be baked in at build time, not runtime.

**Fixes Applied:**

#### a. Added Voice API URL Build Arg to docker-compose.yml
```yaml
frontend:
  build:
    args:
      REACT_APP_VOICE_API_URL: ${REACT_APP_VOICE_API_URL:-http://localhost:14300}
```

#### b. Updated Frontend Dockerfile
Added build args and environment variables for all React env vars:
```dockerfile
ARG REACT_APP_API_URL
ARG REACT_APP_WS_URL
ARG REACT_APP_API_PORT
ARG REACT_APP_WS_PORT
ARG REACT_APP_VOICE_API_URL

ENV REACT_APP_API_URL=$REACT_APP_API_URL
ENV REACT_APP_WS_URL=$REACT_APP_WS_URL
ENV REACT_APP_API_PORT=$REACT_APP_API_PORT
ENV REACT_APP_WS_PORT=$REACT_APP_WS_PORT
ENV REACT_APP_VOICE_API_URL=$REACT_APP_VOICE_API_URL
```

#### c. Updated Fast Deployment Dockerfile
Same build args added to `frontend/Dockerfile.fast` for fast deployments.

#### d. Updated docker-compose.fast.yml
Added build args to pass environment variables:
```yaml
frontend:
  build:
    args:
      REACT_APP_WS_PORT: ${REACT_APP_WS_PORT:-8006}
      REACT_APP_VOICE_API_URL: ${REACT_APP_VOICE_API_URL:-http://localhost:14300}
```

#### e. Updated Deployment Workflow
Added export statements before docker compose build to make environment variables available:
```bash
# Export React environment variables for frontend build
HOST_IP_FROM_ENV=$(grep "HOST_IP=" .env | cut -d'=' -f2)
export REACT_APP_API_URL="http://${HOST_IP_FROM_ENV}:8005"
export REACT_APP_WS_URL="ws://${HOST_IP_FROM_ENV}:8006"
export REACT_APP_API_PORT="8005"
export REACT_APP_WS_PORT="8006"
export REACT_APP_VOICE_API_URL="http://${HOST_IP_FROM_ENV}:14300"
```

## Files Modified

1. `.github/workflows/deploy-self-hosted.yml` - Copy voice directories and export React env vars
2. `claude-workflow-manager/docker-compose.voice.yml` - Removed external network declaration
3. `claude-workflow-manager/docker-compose.yml` - Added REACT_APP_VOICE_API_URL build arg
4. `claude-workflow-manager/docker-compose.fast.yml` - Added voice API URL and WS port build args
5. `claude-workflow-manager/frontend/Dockerfile` - Added all React env vars as build args
6. `claude-workflow-manager/frontend/Dockerfile.fast` - Added all React env vars as build args

## Testing

After these changes, the deployment should:
1. âœ… Successfully copy voice service directories
2. âœ… Create the Docker network correctly
3. âœ… Build and start all voice services
4. âœ… Frontend connects to voice API using server IP (e.g., `http://192.168.1.100:14300`)
5. âœ… Voice output and input components work in the browser

## Deployment Command

The voice services will be automatically included when `PICOVOICE_ACCESS_KEY` is set in GitHub secrets:
```bash
docker compose -f docker-compose.yml -f docker-compose.fast.yml -f docker-compose.voice.yml up -d
```

## Environment Variables Required

In GitHub repository secrets:
- `PICOVOICE_ACCESS_KEY` - Enables voice services
- `HOST_IP` - Server IP address (or auto-detected)

In `.env` file (automatically generated by workflow):
- `PICOVOICE_ACCESS_KEY` - Passed to voice backend
- `REACT_APP_VOICE_API_URL=http://{HOST_IP}:14300` - Used during frontend build

